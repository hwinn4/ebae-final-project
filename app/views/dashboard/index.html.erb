<h1><%= @user.first_name.capitalize %>'s Dashboard</h1>

<h3>Bidding</h3>
<table>
  <tr>
    <th>Item</th>
    <th>Max Bid</th> 
    <th>Current Price</th>
    <th>Winning</th>
    <th>End Date</th>
    <th>Time Left</th>
    <th>Bid History</th>
  </tr>
  <% @user.buyer.unique_listings.each do |listing| %>
    <% if listing.active? %>
      <tr>
        <td><%= link_to listing.item.name, listing_path(listing) %></td>
        <td><%= number_to_currency(listing.highest_bid_by_user(@user).amount / 100.0) %></td> 
        <td><%= number_to_currency(listing.current_price / 100.0) %></td>
        <td><%= (listing.highest_bidder == @user)? "Y" : "N" %></td>
        <td><%= listing.end_time %></td>
        <td><%= listing.time_left %></td>
        <% user_bids = [] %>
        <td><% listing.bids.each do |bid| %>
            <% if bid.buyer.user == @user %>
              <% user_bids << bid %>
            <ul>
              <li><%= number_to_currency(bid.amount / 100.0) %> at <%= bid.created_at %> </li>
              <% end %>
            </ul>
            <% end %>
            Total Bids on item: <%= user_bids.count %> 
          </td>
      </tr>
    <% end %>
  <% end %>
</table>

<h3>Ended</h3>
<table>
  <tr>
    <th>Item</th>
    <th>Max Bid</th> 
    <th>Price</th>
    <th>Won</th>
    <th>End Date</th>
    <th>Bid History</th>
  </tr>
  <% @user.buyer.unique_listings.each do |listing| %>
    <% if listing.inactive? %>
      <tr>
        <td><%= link_to listing.item.name, listing_path(listing) %></td>
        <td><%= number_to_currency(listing.highest_bid_by_user(@user).amount / 100.0) %></td> 
        <td><%= number_to_currency(listing.current_price / 100.0) %></td>
        <td><%= (listing.highest_bidder == @user)? "Y" : "N" %></td>
        <td><%= listing.end_time %></td>
        <% user_bids = [] %>
        <td><% listing.bids.each do |bid| %>
            <% if bid.buyer.user == @user %>
              <% user_bids << bid %>
            <ul>
              <li><%= number_to_currency(bid.amount / 100.0) %> at <%= bid.created_at %>
              <% end %></li>
            </ul>
            <% end %>
            Total Bids on item: <%= user_bids.count %> 
          </td>
      </tr>
    <% end %>
  <% end %>
</table>

<h3>Watching</h3>
<table>
  <tr>
    <th>Item</th>
    <th>Max Bid</th> 
    <th>Current Price</th>
    <th>End Date</th>
    <th>Time Left</th>
    <th></th>
  </tr>
  <% @user.buyer.watchlists.each do |watchlist| %>
    <% if watchlist.listing.active? %>
      <tr>
        <td><%= link_to watchlist.listing.item.name, listing_path(watchlist.listing) %></td>
        <td><%= watchlist.listing.highest_bid ? number_to_currency(watchlist.listing.highest_bid.amount / 100.0) : "No one has bid yet." %></td> 
        <td><%= watchlist.listing.current_price ? number_to_currency(watchlist.listing.current_price / 100.0) : "No one has bid yet." %></td>
        <td><%= watchlist.listing.end_time %></td>
        <td><%= watchlist.listing.time_left %></td>
        <td><%= link_to "Unwatch", watchlist_path(:id => watchlist.id, :listing_id => watchlist.listing.id), :method => :delete %></td>

      </tr>
    <% end %>
  <% end %>
</table>



<h3>Selling: Active Listings</h3>
<table>
  <tr>
    <th>Item</th>
    <th>Max Bid</th> 
    <th>Current Price</th>
    <th>End Date</th>
    <th>Time Left</th>
  </tr>

  <% @user.seller.listings.each do |listing| %>
    <% if listing.active? %>
    <tr>
      <td><a href="/listings/<%= listing.id %>"><%= listing.item.name %></a></td>
      <td><%= listing.highest_bid ? number_to_currency(listing.highest_bid.amount / 100.0) : number_to_currency(0) %></td>
      <td><%= listing.current_price ? number_to_currency(listing.current_price / 100.0) : number_to_currency(0) %></td>
      <td><%= listing.end_time %></td>
      <td><%= listing.time_left %></td>
    </tr>
    <% end %>
  <% end %>
  </table>

<h3>Selling: Completed Listings</h3>
<table>
  <tr>
    <th>Item</th>
    <th>Max Bid</th> 
    <th>Sale Price</th>
    <th>Buyer</th>
    <th>End Date</th>
  </tr>

  <% @user.seller.listings.each do |listing| %>
    <% if listing.inactive? %>
    <tr>
      <td><a href="/listings/<%= listing.id %>"><%= listing.item.name %></a></td>
      <td><%= listing.highest_bid ? number_to_currency(listing.highest_bid.amount / 100.0) : number_to_currency(0) %></td>
      <td><%= listing.current_price ? number_to_currency(listing.current_price / 100.0) : number_to_currency(0) %></td>
      <td>Holding place for buyer email</td>
      <td><%= listing.end_time %></td>
    </tr>
    <% end %>
  <% end %>
  </table>
